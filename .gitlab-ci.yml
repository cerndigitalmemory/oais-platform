stages:
  - isort
  - black
  - test
  - create_image

check-isort:
  stage: isort
  image: registry.cern.ch/docker.io/library/python:3.11
  before_script:
    - pip install --upgrade pip
    - pip install wheel==0.45.1
    - pip install isort==5.13
  script:
    - isort --profile black -c --skip "migrations" .

check-black:
  stage: black
  image: registry.cern.ch/docker.io/library/python:3.11
  before_script:
    - pip install --upgrade pip
    - pip install black==24.10
  script:
    - black . --check --exclude "oais_platform/oais/migrations"

django-tests:
  stage: test
  image: registry.cern.ch/docker.io/library/docker:20.10.16
  services:
    - name: registry.cern.ch/docker.io/library/docker:20.10.16-dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker info
    - docker-compose -f test-compose.yml up --exit-code-from django
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura 
        path: coverage.xml
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  tags:
    - docker-privileged-xl
    
create_image:
  stage: create_image
  only:
    - tags  # This ensures the job only runs when there is a tag
  script:
    # Log in to GitLab Container Registry using GitLab CI/CD environment variables
    - echo $CI_JOB_TOKEN | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY

    # Build the Docker image (adjust the Dockerfile path if necessary)
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME .

    # Push the image to the GitLab Container Registry
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
