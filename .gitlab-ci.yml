stages:
  - format
  - test
  - build
  - deploy

check-isort:
  stage: format
  image: registry.cern.ch/docker.io/library/python:3.11
  before_script:
    - pip install --upgrade pip
    - pip install wheel==0.45.1
    - pip install isort==5.13
  script:
    - isort --profile black -c --skip "migrations" .

check-black:
  stage: format
  image: registry.cern.ch/docker.io/library/python:3.11
  before_script:
    - pip install --upgrade pip
    - pip install black==24.10
  script:
    - black . --check --exclude "oais_platform/oais/migrations"

django-tests:
  stage: test
  image: registry.cern.ch/docker.io/library/docker:20.10.16
  services:
    - name: registry.cern.ch/docker.io/library/docker:20.10.16-dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  script:
    - docker info
    - docker-compose -f test-compose.yml up --exit-code-from django
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura 
        path: coverage.xml
  coverage: '/TOTAL.+ ([0-9]{1,3}%)/'
  tags:
    - docker-privileged-xl
    
build-image:
  stage: build
  image:
    name: registry.cern.ch/gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  rules:
    - if: '$CI_COMMIT_TAG'
  script:
    # Configure Kaniko to authenticate with GitLab Container Registry
    - mkdir -p /kaniko/.docker
    - >
      echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" 
      > /kaniko/.docker/config.json

    # Build and push the Docker image
    - /kaniko/executor
      --context "$CI_PROJECT_DIR"
      --dockerfile "$CI_PROJECT_DIR/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}"
      --cache=true

.deploy_template: &deploy_template
  stage: deploy
  when: manual
  image: registry.cern.ch/docker.io/library/docker:20.10.16
  services:
    - name: registry.cern.ch/docker.io/library/docker:20.10.16-dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  rules:
    - if: '$CI_COMMIT_TAG'
  allow_failure: false
  script:
    - |
      docker pull ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
      docker tag ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG} \
        ${CI_REGISTRY_IMAGE}:${DEPLOY_ENV}
      docker push ${CI_REGISTRY_IMAGE}:$DEPLOY_ENV
  tags:
    - docker-privileged-xl

deploy-dev:
  <<: *deploy_template
  variables:
    DEPLOY_ENV: "dev"

deploy-qa:
  <<: *deploy_template
  variables:
    DEPLOY_ENV: "qa"

deploy-prod:
  <<: *deploy_template
  variables:
    DEPLOY_ENV: "prod"
